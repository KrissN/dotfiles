#!/bin/bash

pushd $HOME

DESTS=""
HOSTDESTS=""

# build a list of dotfiles to copy from git.  we explicitly include
# .zsh.d and .emacs.d because git doesn't list directories and we want
# to make sure to copy everything in those directories, including
# stuff that's not committed to git
DOTFILES=".zsh.d .emacs.d bin sw"
pushd $HOME
DOTFILES="$DOTFILES $(git ls-files | grep -v 'README\|\.zsh\.d/\|\.emacs\.d/')"
popd

. .syncdot

if [[ -n "$@" ]]; then
    HOSTDESTS="$@"
fi

for dest in $DESTS; do
    echo "copying to $dest"
    for file in $DOTFILES; do
        dir=$(dirname $file)
        if [[ -n $dir ]]; then
            mkdir -p $dest/$dir
            cp -R $file $dest/$dir
        else
            cp -R $file $dest
        fi
    done
done

for host in $HOSTDESTS; do
    echo "copying to $host"
    tar -cf - $DOTFILES | ssh -q $host 'tar -xf -'
done

popd
