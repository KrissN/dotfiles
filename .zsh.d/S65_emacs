#!/bin/zsh

function __start_emacs_server() {
    # start emacs server
    if ! pgrep -f -U $USER '[Ee]macs.* --daemon' >& /dev/null; then
        $__emacs_bin --daemon >& /dev/null
    fi
}

if [[ -e /Applications/Emacs.app/Contents/MacOS/bin ]]; then
    # this needs to be first in PATH, or at least before /usr/bin.
    # The easiest way to do that is to remove it before adding it.
    pathremove /Applications/Emacs.app/Contents/MacOS/bin
    pathmunge /Applications/Emacs.app/Contents/MacOS/bin
fi

if type emacs >& /dev/null; then
    if [[ -z $__emacs_bin ]]; then
        if [[ $(type emacs) == "emacs is a shell function" ]]; then
            unfunction emacs
        fi

        # OS X crap
        if [[ -e /Applications/Emacs.app/Contents/MacOS/Emacs ]]; then
            __emacs_bin="/Applications/Emacs.app/Contents/MacOS/Emacs"
        else
            __emacs_bin=$(which emacs)
        fi
    fi
    __emacs_version=$($__emacs_bin --version | head -n 1 | \
        awk '{ split($NF, v, "."); print v[1] "." v[2]; }')

    if type emacsclient >& /dev/null && [[ $__emacs_version -ge 23.1 ]]; then
        function emacs() {
            __start_emacs_server
            args="-n"
            if [[ $(uname) == "Darwin" || -n $DISPLAY ]]; then
                args="$args -c"
            else
                args="$args -t"
            fi
            args="$args $@"
            emacsclient ${=args}
        }

        function emacs-kill() {
            emacsclient -e '(kill-emacs)'
        }

        __start_emacs_server
        export ALTERNATIVE_EDITOR=""
    fi
    export EDITOR=emacs
elif type vim >& /dev/null; then
    export EDITOR=vim
else
    export EDITOR=vi
fi

alias emcas=$EDITOR
alias vi=$EDITOR

# don't use python inside a virtualenv to run pymacs
export PYMACS_PYTHON=$(which python)
